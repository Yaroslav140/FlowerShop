@page
@using FlowerShop.Data.Models
@using FlowerShop.Dto.DTOGet
@model FlowerShop.Web.Pages.Account.ViewOrdersModel
@if (TempData["ErrorMessage"] is string msg)
{
    <div class="alert alert-danger">@msg</div>
}
<div class="container">
    <a asp-page="/Account/Profile" class="back-link">← Вернуться назад</a>

    <div class="content">
        <h1 class="content__main">Мои заказы</h1>
        <p class="content__description">Отслеживайте свою историю заказов</p>
    </div>

    <div class="grid">
        @if (Model.Orders.Any())
        {
            @foreach (var order in Model.Orders)
            {
                var item = order.OrderItem.FirstOrDefault();
                var bouquet = item?.Bouquet;

                <article class="order-row">
                    <div class="order-left">
                        <img class="order-thumb" src="@Url.Content(bouquet?.ImagePath ?? "/images/no-image.png")" alt="@bouquet?.Name" />
                        <div class="order-text">
                            <h3 class="order-title">@bouquet?.Name</h3>
                            <div class="order-meta">
@*                                 <div>Секретный код: <span>@Model.SecredCode</span></div> *@
                                <div>Дата получения: <span>@order.PickupDate.ToString("dd-MM-yyyy")</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="order-status">
                        <div class="status-line">
                            <span class="status-dot status-@order.Status.ToString().ToLower()"></span>
                            @switch (order.Status)
                            {
                                case OrderStatus.New:
                                    <span class="status-text">Новый</span>
                                    break;
                                case OrderStatus.Pending:
                                    <span class="status-text">Ожидает обработки</span>
                                    break;
                                case OrderStatus.InProgress:
                                    <span class="status-text">В обработке</span>
                                    break;
                                case OrderStatus.Completed:
                                    <span class="status-text">Выполнен</span>
                                    break;
                                case OrderStatus.Cancelled:
                                    <span class="status-text">Отменён</span>
                                    break;
                                default:
                                    <span class="status-text">@order.Status</span>
                                    break;
                            }
                        </div>

                        @if (order.Status == OrderStatus.Completed)
                        {
                            <span class="badge badge--delivered">Выполнен</span>
                        }
                    </div>


                    <div class="order-price">
                        @order.TotalAmount ₽
                    </div>

                    <div class="order-actions">
                        <a class="btn btn--brand btn--sm" asp-page="/Account/ViewOrderDetails" asp-route-id="@order.Id"> Подробнее </a>
                        <form method="post">
                            <input type="hidden" name="orderId" value="@order.Id" />
                            <button asp-page-handler="RepeatOrder" class="btn btn--outline-pink btn--sm">
                                Повторить заказ
                            </button>
                        </form>

                    </div>
                </article>
            }
        }
        else
        {
            <div class="cart-empty">
                <img class="cart-empty__img" src="/images/empty.png" alt="">
                <h3 class="cart-empty__title">Пока нет заказов</h3>
                <p class="cart-empty__text">Соберите первый букет — это быстро и приятно.</p>
                <a asp-page="/PageHeader/Bouquets" class="btn btn--brand cart-summary__checkout">Перейти к букетам</a>
            </div>
        }
    </div>

    @{
        var delivered = Model.Orders.Count(o => (o.Status.ToString() ?? "").Equals("Completed", StringComparison.OrdinalIgnoreCase));
        var active = Model.Orders.Count - delivered;
    }
    <div class="grid profile-card order-summary">
        <h3 class="order-summary__title">Краткое описание заказов</h3>
        <div class="grid order-summary__grid">
            <div>
                <div class="orders-count order-summary__count">@Model.Orders.Count</div>
                <div class="orders-caption order-summary__caption">Всего заказов</div>
            </div>
            <div>
                <div class="orders-count order-summary__count">@delivered</div>
                <div class="orders-caption order-summary__caption">Доставлено</div>
            </div>
            <div>
                <div class="orders-count order-summary__count">@active</div>
                <div class="orders-caption order-summary__caption">Активные</div>
            </div>
        </div>
    </div>
</div>
