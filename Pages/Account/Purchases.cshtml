@page
@model FlowerShop.Web.Pages.Account.PurchasesModel
@using System.Globalization
@{
    var ru = new CultureInfo("ru-RU");
    var subtotal = Model.CartEntities?.Sum(ci => ci.Bouquet.Price * ci.Quantity) ?? 0m;
}

<div class="container cart">
    @if (Model.CartEntities != null && Model.CartEntities.Count > 0)
    {
        <div class="cart__head">
            <div>
                <h1 class="cart__title">Корзина</h1>
                <p class="cart__subtitle">@Model.CartEntities.Count позиций в вашей корзине</p>
            </div>
            <form method="post" asp-page-handler="ClearCarts">
                <button class="btn btn--outline-pink cart__clear" type="submit">Очистить корзину</button>
            </form>
        </div>

        <div class="cart__grid grid">
            <section class="cart__list">
                @foreach (var item in Model.CartEntities)
                {
                    <article class="cart-item">
                        <img src="@Url.Content(item.Bouquet.ImageUrl)" alt="@item.Bouquet.Name" class="cart-item__img" />

                        <div class="cart-item__info">
                            <h2 class="cart-item__title">@item.Bouquet.Name</h2>
                            <div class="cart-item__price">
                                @item.Bouquet.Price.ToString("C", ru)
                            </div>
                            <form method="post" class="cart-item__qty">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="cartId" value="@item.Id" />
                            
                                <button type="submit" asp-page-handler="UpdateQuantity"
                                        name="direction" value="decrease" class="qty__btn">−</button>
                            
                                <span class="qty__value">@item.Quantity</span>
                            
                                <button type="submit" asp-page-handler="UpdateQuantity"
                                        name="direction" value="increase" class="qty__btn">+</button>
                            </form>

                        </div>

                        <div class="cart-item__total">
                            @((item.Bouquet.Price * item.Quantity).ToString("C", ru))
                        </div>

                        <form method="post" class="cart-item__remove">
                            <input type="hidden" name="cartId" value="@item.Id" />
                            <button type="submit" asp-page-handler="RemoveFromCart" title="Удалить" class="remove__btn">×</button>
                        </form>
                    </article>
                }
            </section>

            <aside class="cart-summary">
                <h3 class="cart-summary__title">Итоги заказа</h3>

                <div class="cart-summary__row">
                    <span>Итого (@Model.CartEntities.Count шт.)</span>
                    <strong>@subtotal.ToString("C", ru)</strong>
                </div>
                <hr class="cart-summary__divider" />
                <div class="cart-summary__row cart-summary__row--total">
                    <span>Итого</span>
                    <strong>@subtotal.ToString("C", ru)</strong>
                </div>

                <form method="post" asp-page-handler="ProceedToCheckout">
                    <button class="btn btn--brand cart-summary__checkout" type="submit">Перейти к оформлению</button>
                </form>

                <a class="cart-summary__link" asp-page="/PageHeader/Bouquets">Продолжить покупки</a>
            </aside>
        </div>
    }
    else
    {
        <div class="cart-empty center">
            <div>
                <img src="@Url.Content("~/img/ShopCart.png")" alt="Корзина пустая" class="cart-empty__img" />
                <h2 class="cart-empty__title">Ваша корзина пуста</h2>
                <p class="cart-empty__text">Добавьте несколько красивых букетов, чтобы начать</p>
                <a class="btn btn--brand btn--pill" asp-page="/PageHeader/Bouquets">К букетам</a>
            </div>
        </div>
    }
</div>
