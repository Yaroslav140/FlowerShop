@page
@using FlowerShop.Data.Models
@model FlowerShop.Web.Pages.Account.ViewOrderDetailsModel
@{
    var order = Model.Order;
    var firstItem = order?.OrderItem?.FirstOrDefault();

    string BadgeClass(OrderStatus s)
        => s == OrderStatus.Completed ? "badge badge--delivered" : "badge";
}
@if (TempData["SuccessMessage"] is string ok)
{
    <div class="alert success">@ok</div>
}
@if (TempData["ErrorMessage"] is string err)
{
    <div class="alert error">@err</div>
}

@if (order is null)
{
    <div class="center" style="min-height:50vh;">Заказ не найден.</div>
}
else
{
    <div class="container">
        <nav style="margin-bottom:8px;">
            <a href="@(Url.Page("/Account/ViewOrders"))" class="container-header__nav-link">← Вернуться к заказам</a>
        </nav>

        <header class="content" style="padding-top:8px; padding-bottom:0;">
            <h1 class="content__main" style="font-size:28px;">Детали заказа</h1>
            <p class="content__description" style="margin-top:-6px;">
                <span>Order ID: </span><strong>@order.Id.ToString()[..8]…</strong>
            </p>
        </header>

        <section class="profile-card" style="max-width:var(--container); margin:16px auto;">
            <div class="card-header" style="justify-content:space-between;">
                <div style="font-weight:700;">Статус заказа</div>
                <span class="@BadgeClass(order.Status)" data-status="@order.Status">@order.Status</span>
            </div>

            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin:0;">
                <div>
                    <div class="label">Дата выполнения заказа</div>
                    <div class="value">@order.PickupDate.ToString("dd-MM-yyyy")</div>
                </div>
                <div>
                    <div class="label">
                        @if(order.Status == OrderStatus.Completed)
                        {
                            <div class="label">Дата выполнения</div>
                            <div class="value">@order.PickupDate.ToString("yyyy-MM-dd")</div>
                        }
                </div>
            </div>
        </div>

        @if (order.Status == OrderStatus.Pending || order.Status == OrderStatus.New)
            {
                <div style="margin-top:14px;">
                    <form method="post">
                        <button type="submit" asp-page-handler="CancelOrder" asp-route-id="@order.Id" class="btn btn--outline-pink">Отменить заказ</button>
                    </form>
                </div>
            }
            else if (order.Status == OrderStatus.Completed)
            {
                <p class="hint" style="margin-top:10px;">Заказ доставлен. Спасибо, что выбрали нас!</p>
            }
            else if (order.Status == OrderStatus.Cancelled)
            {
                <p class="hint" style="margin-top:10px; color:#b91c1c;">Заказ был отменён.</p>
            }
        </section>

        <section style="margin-top:16px;">
            <h2 class="profile-title" style="font-size:22px; text-align:left;">Детали букетов</h2>

            @if (order.OrderItem is { Count: > 0 })
            {
                <div class="bouquet-container" style="padding-left:0; padding-right:0;">
                    @foreach (var i in order.OrderItem)
                    {
                        <article class="bouquet-card">
                            <img src="@(i.Bouquet?.ImagePath ?? "/img/placeholder-bouquet.png")"
                                 alt="@(i.Bouquet?.Name ?? "Bouquet")" />

                            <div class="bouquet-card__description">
                                <h3 class="bouquet-card__title">@i.Bouquet?.Name</h3>
                                @if (!string.IsNullOrWhiteSpace(i.Bouquet?.Description))
                                {
                                    <p class="bouquet-card__text">@i.Bouquet!.Description</p>
                                }
                                <div class="bouquet-card__price">
                                    @i.Price.ToString("C") <span style="font-weight:600; color:#555;">× @i.Quantity</span>
                                </div>
                            </div>
                        </article>
                    }
                </div>
            }
            else
            {
                <div class="cart-empty">
                    <img class="cart-empty__img" src="/img/placeholder-bouquet.png" alt="">
                    <p class="cart-empty__text">Позиции заказа не найдены.</p>
                </div>
            }
        </section>

        <section class="profile-card" style="max-width:var(--container); margin:16px auto;">
            <div class="card-header">
                <div>Онфрмация о покупатели</div>
            </div>

            <div class="info-list">
                <div class="row">
                    <div class="label">Имя получателя</div>
                    <div class="value">@(!string.IsNullOrWhiteSpace(Model.UserInfo?.Username) ? Model.UserInfo.Username : Model.UserInfo?.Login)</div>
                </div>

                <div class="row">
                    <div class="label">Логин</div>
                    <div class="value login">@Model.UserInfo?.Login</div>
                </div>
            </div>
        </section>

        <section class="profile-card order-summary-card" style="max-width:var(--container); margin:16px auto;">
            <div class="card-header">
                <div>Краткое описание заказа</div>
            </div>

            <div class="order-summary">
                @foreach (var i in order.OrderItem)
                {
                    var lineTotal = i.Price * i.Quantity;
                    <div class="order-summary__row">
                        <div class="label">
                            @i.Bouquet?.Name
                            <span style="color:var(--muted); font-weight:600;"> × @i.Quantity</span>
                            <div style="font-size:12px; color:var(--muted); margin-top:2px;">
                                @i.Price.ToString("C") за шт.
                            </div>
                        </div>
                        <div class="value" style="font-variant-numeric: tabular-nums;">
                            @lineTotal.ToString("C")
                        </div>
                    </div>
                }

                <hr class="order-summary__divider" />

                <div class="order-summary__row order-summary__row--total">
                    <div class="label">Итого</div>
                    <div class="value" style="color:var(--brand); font-weight:800; font-variant-numeric: tabular-nums;">
                        @order.TotalAmount.ToString("C")
                    </div>
                </div>
            </div>
        </section>

        <!-- две широкие кнопки внизу -->
        <div class="order-actions-bar" style="max-width:var(--container); margin:12px auto 0;">
            <a class="btn btn--outline-pink btn-wide"
               asp-page="/PageHeader/Contacts" asp-route-orderId="@order.Id">
                Контакт поддержки
            </a>
        </div>
    </div>
}
